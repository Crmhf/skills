# 架构决策记录 (ADR) 规范

架构决策记录（ADR）用于捕获重要的架构决策及其上下文和后果。

---

## 1. 什么是 ADR

### 定义
ADR 是对架构上重要的决策的简短文本文件，记录决策的上下文、决策本身以及其后果。

### 何时编写 ADR

| 场景 | 是否需要 ADR | 级别 |
|-----|-------------|------|
| 选择编程语言/框架 | ✅ | L1-战略 |
| 引入新数据库类型 | ✅ | L1-战略 |
| 服务拆分策略 | ✅ | L2-重要 |
| API 设计规范 | ✅ | L2-重要 |
| 代码格式化配置 | ❌ | L4-细节 |
| 变量命名 | ❌ | L4-细节 |

---

## 2. ADR 生命周期

```
提案 → 审议 → 已接受/已拒绝 → 实施 → (可选)已废弃
  ↑___________________________________________|
                    定期回顾
```

### 状态定义

- **提案中**: 草案阶段，收集反馈
- **审议中**: 正式评审中
- **已接受**: 决策通过，开始实施
- **已拒绝**: 决策未通过，记录原因
- **已废弃**: 原决策不再有效，已被替代
- **已替代**: 指向新的 ADR

---

## 3. ADR 格式模板

### 标准模板

```markdown
# ADR-[序号]: [简洁的决策标题]

## 状态
- 提案中 / 审议中 / 已接受 / 已拒绝 / 已废弃 / 已替代

## 背景
[描述需要做出决策的问题背景、业务上下文、技术约束]

## 决策
[明确、简洁地陈述所做的决策]

## 原因
[列出支持该决策的关键因素，可以包括：]
- 业务需求
- 技术约束
- 团队能力
- 成本考虑
- 时间压力

## 备选方案

### 方案A: [名称]
**优点:**
- ...

**缺点:**
- ...

### 方案B: [名称]
**优点:**
- ...

**缺点:**
- ...

## 后果

### 正面影响
- ...

### 负面影响
- ...

### 风险
- ...

## 实施计划
1. [阶段1: 时间和任务]
2. [阶段2: 时间和任务]
3. [阶段3: 时间和任务]

## 相关决策
- ADR-[序号]: [标题]
- ADR-[序号]: [标题]

## 参考资料
- [链接1]
- [链接2]

## 记录
| 日期 | 作者 | 操作 |
|-----|------|------|
| 2024-01-15 | 张三 | 创建提案 |
| 2024-01-18 | 李四 | 接受决策 |
```

---

## 4. 决策记录示例

### 示例1: 数据库选型

```markdown
# ADR-001: 采用 PostgreSQL 作为主数据库

## 状态
已接受 (2024-01-20)

## 背景
我们的应用需要存储复杂的数据结构（JSON 商品属性），
当前使用的 MySQL 5.7 在 JSON 支持和全文检索方面存在限制。

## 决策
采用 PostgreSQL 15 作为新的主数据库。

## 原因
1. JSONB 类型提供高效的 JSON 存储和查询
2. 内置全文检索，无需额外引入 Elasticsearch
3. 支持地理空间数据（PostGIS），为未来功能预留
4. 活跃的开源社区，长期支持有保障

## 备选方案

### MySQL 8.0
**优点:** 团队熟悉，迁移成本低
**缺点:** JSON 功能较弱，全文检索不够强大

### MongoDB
**优点:** JSON 原生支持，Schema 灵活
**缺点:** 事务支持较弱，不适合金融场景

## 后果

### 正面
- 简化技术栈，减少 Elasticsearch 依赖
- 查询能力提升，应用层逻辑简化

### 负面
- 需要培训 DBA 学习 PostgreSQL
- 迁移期间需要双写，增加复杂度

## 实施计划
- Q1: 搭建 PostgreSQL 集群，完成数据同步验证
- Q2: 灰度迁移只读查询流量
- Q3: 切换写入流量，MySQL 作为备份
- Q4: 下线 MySQL
```

### 示例2: API 协议选择

```markdown
# ADR-015: 微服务间通信采用 gRPC

## 状态
已接受 (2024-03-10)

## 背景
随着服务拆分，服务间调用越来越多，REST API 的性能瓶颈显现：
- JSON 序列化开销大
- HTTP/1.1 连接效率低
- 缺少强类型契约

## 决策
微服务间内部通信采用 gRPC，对外暴露 REST API（通过网关转换）。

## 原因
1. HTTP/2 多路复用，降低连接开销
2. Protocol Buffers 高效序列化
3. 强类型接口定义，减少集成错误
4. 双向流支持，适合实时场景

## 备选方案

### 继续使用 REST
**优点:** 无学习成本，调试方便
**缺点:** 性能无法满足要求

### GraphQL
**优点:** 灵活的数据获取
**缺点:** 学习曲线陡峭，不适合内部服务通信

## 后果

### 正面
- 服务间调用延迟降低 50%
- 类型安全减少运行时错误

### 负面
- 需要学习 Protocol Buffers
- 调试工具不如 REST 丰富
```

---

## 5. 决策分级

### L1 - 战略级
- **范围**: 整个技术栈、架构风格
- **决策者**: CTO / 首席架构师
- **影响**: 3-5 年
- **示例**: 选择云厂商、单体 vs 微服务

### L2 - 重要级
- **范围**: 多个团队、核心系统
- **决策者**: 架构师委员会
- **影响**: 1-2 年
- **示例**: 引入新数据库、服务拆分策略

### L3 - 常规级
- **范围**: 单个团队、模块内部
- **决策者**: Tech Lead
- **影响**: 3-6 个月
- **示例**: 选择日志框架、缓存策略

### L4 - 细节级
- **范围**: 代码级别
- **决策者**: 开发者
- **影响**: 当前迭代
- **示例**: 变量命名、函数拆分

---

## 6. ADR 管理流程

### 创建流程

```
1. 识别决策需求
   └── 判断是否需要 ADR（参考决策分级）

2. 编写草案
   └── 使用模板填写背景、备选方案

3. 收集反馈
   └── 分享给相关干系人（2-3天）

4. 技术评审
   └── 架构评审会讨论

5. 批准/拒绝
   └── 更新状态，记录原因

6. 实施跟踪
   └── 定期检查实施进度
```

### 存储规范

```
docs/
└── decisions/
    ├── README.md           # 决策日志索引
    ├── 001-postgresql-database.md
    ├── 015-grpc-communication.md
    ├── 023-kafka-messaging.md
    └── template.md         # ADR 模板
```

### 索引文件示例

```markdown
# 架构决策日志

## 按状态

### 已接受
- [ADR-001](001-postgresql-database.md) - 采用 PostgreSQL 作为主数据库
- [ADR-015](015-grpc-communication.md) - 微服务间通信采用 gRPC

### 提案中
- [ADR-024](024-graphql-api.md) - 对外 API 采用 GraphQL

### 已废弃
- [ADR-005](005-mysql-sharding.md) - ~~MySQL 分片方案~~ (被 ADR-001 替代)

## 按类别

### 数据存储
- [ADR-001](001-postgresql-database.md) - 采用 PostgreSQL

### 通信协议
- [ADR-015](015-grpc-communication.md) - 内部通信采用 gRPC

### 基础设施
- [ADR-020](020-kubernetes-platform.md) - 采用 Kubernetes 作为容器平台
```

---

## 7. 最佳实践

### DO ✅
- 保持简洁（1-2页）
- 记录原因，不仅仅是决策
- 记录备选方案及其优缺点
- 明确状态和时间
- 定期回顾和更新

### DON'T ❌
- 过度设计细节决策
- 只记录成功的决策
- 复制粘贴大量代码
- 忽略负面后果
- 创建后不再维护

---

## 8. 工具推荐

| 工具 | 用途 | 推荐场景 |
|-----|------|---------|
| Markdown + Git | 版本控制 | 小型团队 |
| Confluence | 企业 Wiki | 大型组织 |
| Notion | 协作文档 | 远程团队 |
| Log4brains | 专用 ADR 工具 | ADR 重度用户 |
| adr-tools | CLI 工具 | 开发者友好 |
