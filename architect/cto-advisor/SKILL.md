---
name: cto-advisor
description: 工程团队技术领导力指导，提供技术债务分析、团队扩展计算、DORA 指标框架、架构决策记录模板、技术评估工具，帮助技术领导者做出数据驱动的决策。
triggers:
  - 技术债务
  - 团队扩展
  - 技术选型
  - 架构决策
  - DORA指标
  - 工程效能
  - 技术评估
  - 团队管理
  - 技术战略
  - 技术领导力
---

# CTO 技术顾问

工程团队技术领导力指导，帮助技术管理者做出数据驱动的决策。

---

## 核心能力

| 能力领域 | 具体技能 |
|---------|---------|
| 技术债务分析 | 识别技术债务、计算偿还成本、制定偿还计划 |
| 团队扩展计算 | 团队规模规划、招聘节奏、预算评估、风险评估 |
| 工程指标框架 | DORA 四大指标、工程效能度量、持续交付能力评估 |
| 架构决策记录 | ADR 模板、决策流程、技术选型评估框架 |
| 技术评估工具 | 技术栈评估、供应商选型、开源 vs 自研决策 |

---

## 使用方法

### 技术债务分析

```bash
python scripts/tech_debt_analyzer.py --path ./src --format json
```

### 团队扩展计算

```bash
python scripts/team_scaling_calculator.py --current 20 --target 50 --months 12
```

---

## 技术债务管理

### 技术债务分类

| 类型 | 描述 | 示例 | 优先级 |
|-----|------|------|--------|
| 代码债务 | 代码质量问题 | 重复代码、圈复杂度高 | 高 |
| 架构债务 | 架构设计问题 | 分层不清、模块耦合 | 高 |
| 测试债务 | 测试覆盖不足 | 缺少单元测试、集成测试 | 高 |
| 文档债务 | 文档缺失或过时 | API 文档、架构文档 | 中 |
| 基础设施债务 | 运维问题 | 缺少 CI/CD、监控告警 | 高 |
| 依赖债务 | 过时依赖 | 旧版本框架、安全漏洞 | 高 |

### 技术债务计算公式

```
技术债务比率 = (修复债务所需人天 / 当前代码总人天) × 100%

健康阈值:
- < 5%: 健康
- 5% - 10%: 可控
- 10% - 20%: 需关注
- > 20%: 危险
```

### 偿还策略

1. **绞杀者模式**: 新功能使用新架构，旧功能逐步迁移
2. **20%规则**: 每个迭代预留 20% 时间偿还债务
3. **债务冲刺**: 定期（如每季度）安排专项债务清理
4. **重构保护**: 修改哪部分代码，就重构那部分

---

## 团队扩展规划

### 扩展模型

```
团队扩展曲线:
人数
 ↑
50 │                                    ●──── 目标规模
   │                               ●────
40 │                          ●────
   │                     ●────
30 │                ●────
   │           ●────
20 │────●─────── 当前规模
   │
10 └────┬────┬────┬────┬────┬────┬────┬────→ 时间
        0    2    4    6    8    10   12  (月)
```

### 关键指标

| 指标 | 计算方法 | 健康范围 |
|-----|---------|---------|
| 人效 | 交付故事点 / 人数 | 稳定或增长 |
| 沟通成本 | n(n-1)/2 | 需控制增长 |
| 交付周期 | 需求提出到上线天数 | < 2周 |
| 代码审查延迟 | PR 提交到合并平均时间 | < 4小时 |

### 扩展风险与应对

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 文化稀释 | 新人难以融入 | 完善入职培训、导师制度 |
| 沟通效率下降 | 会议增多、决策慢 | 分层管理、小团队自治 |
| 代码质量下降 | 技术债务增加 | 代码审查、自动化检查 |
| 交付速度下降 | 人效降低 | 优化流程、工具链升级 |

---

## DORA 指标框架

### 四大核心指标

```
┌─────────────────────────────────────────────────────┐
│                   DORA 指标                         │
├─────────────────┬───────────────────────────────────┤
│  部署频率       │  变更前置时间                      │
│  (Deployment    │  (Lead Time for                   │
│   Frequency)    │   Changes)                        │
├─────────────────┼───────────────────────────────────┤
│  变更失败率     │  服务恢复时间                      │
│  (Change        │  (Time to Restore                  │
│   Failure Rate) │   Service)                        │
└─────────────────┴───────────────────────────────────┘
```

### 指标等级

| 指标 | 精英级 | 高绩效 | 中等 | 低绩效 |
|-----|--------|--------|------|--------|
| 部署频率 | 按需/每天多次 | 每天一次-每周一次 | 每周一次-每月一次 | 少于每月一次 |
| 变更前置时间 | < 1小时 | < 1周 | 1周-1月 | > 1月 |
| 变更失败率 | < 5% | 5%-15% | 16%-30% | > 30% |
| 服务恢复时间 | < 1小时 | < 1天 | 1天-1周 | > 1周 |

### 度量方法

**部署频率:**
```
统计周期内的生产环境部署次数
部署频率 = 部署次数 / 统计天数
```

**变更前置时间:**
```
代码提交到生产部署的平均时间
前置时间 = Σ(部署时间 - 首次提交时间) / 部署次数
```

**变更失败率:**
```
导致事故的部署占比
失败率 = 失败部署次数 / 总部署次数 × 100%
```

**服务恢复时间:**
```
故障发生到恢复的平均时间
恢复时间 = Σ(恢复时间 - 故障时间) / 故障次数
```

---

## 技术选型评估框架

### 评估维度

```
技术选型评分卡:

维度          权重    选项A    选项B    选项C
─────────────────────────────────────────────
功能性        20%      8        9        7
性能          20%      7        8        9
可靠性        15%      9        8        7
可维护性      15%      8        7        6
学习成本      10%      9        7        5
生态成熟度    10%      9        8        6
成本          10%      7        6        8
─────────────────────────────────────────────
加权总分      100%    7.9      7.75     7.05
```

### 决策矩阵

| 场景 | 优先考虑 | 次要考虑 |
|-----|---------|---------|
| 初创公司 MVP | 开发速度、学习成本 | 扩展性、性能 |
| 企业级系统 | 可靠性、生态成熟度 | 性能、成本 |
| 高并发系统 | 性能、可靠性 | 功能性、生态 |
| 长期维护项目 | 可维护性、生态成熟度 | 功能性 |

---

## 参考文档

- `references/architecture_decision_records.md` - 架构决策记录规范与模板
- `references/engineering_metrics.md` - 工程指标体系与度量方法
- `references/technology_evaluation_framework.md` - 技术评估框架与决策流程

---

## 标杆角色对话示例

### 示例1：技术债务评估

**用户:** 我们的系统已经运行3年了，最近开发速度越来越慢，怎么评估技术债务？

**CTO 顾问:** 我来帮您进行系统性的技术债务评估。让我先扫描代码库：

```bash
python scripts/tech_debt_analyzer.py --path ./src --sonar-url http://sonar.internal
```

**评估结果摘要：**

| 债务类型 | 严重程度 | 估计修复成本 | 业务影响 |
|---------|---------|-------------|---------|
| 代码债务 | 高 | 120人天 | 维护困难，Bug 率高 |
| 架构债务 | 高 | 200人天 | 扩展受限，性能瓶颈 |
| 测试债务 | 中 | 80人天 | 回归成本高 |
| 基础设施债务 | 高 | 60人天 | 部署风险，故障恢复慢 |
| 依赖债务 | 中 | 40人天 | 安全风险 |

**技术债务比率: 18% (需关注)**

**优先处理建议：**

1. **P0 - 立即处理（基础设施债务）**
   - 升级 CI/CD 流水线
   - 完善监控告警
   - 预计 1 个月，投入 3 人

2. **P1 - 本季度处理（依赖债务 + 核心代码）**
   - 升级 Spring Boot 到最新版
   - 重构核心模块的高复杂度方法
   - 预计 2 个月，投入 20% 带宽

3. **P2 - 下半年规划（架构债务）**
   - 服务拆分规划
   - 数据库分表方案
   - 需要专项预算

**建议实施"20%规则"：每个迭代预留 20% 时间用于技术债务偿还。**

---

### 示例2：团队扩展规划

**用户:** 我们团队目前 15 人，计划明年扩展到 50 人，需要怎么规划？

**CTO 顾问:** 从 15 人到 50 人是 3 倍增长，需要系统性的扩展规划。让我计算一下：

```bash
python scripts/team_scaling_calculator.py \
  --current 15 --target 50 --months 12 \
  --current-productivity 100 --onboarding-months 3
```

**计算结果：**

| 指标 | 当前 | 6个月后 | 12个月后 |
|-----|------|--------|---------|
| 团队规模 | 15 | 32 | 50 |
| 月新增人数 | - | 2-3 | 2-3 |
| 有效产出 | 100% | 75% | 85% |
| 人均产出 | 100% | 85% | 75% |

**扩展路线图：**

```
第1季度 (15→25人):
├── 招聘: 后端 6人，前端 3人，测试 1人
├── 组织: 拆分为 2 个开发小组
├── 预算: 人力成本 +67%
└── 风险: 招聘速度可能跟不上

第2季度 (25→35人):
├── 招聘: 各组按需补充
├── 组织: 引入 Tech Lead 角色
├── 流程: 完善代码审查、发布流程
└── 风险: 文化稀释，需加强团队建设

第3-4季度 (35→50人):
├── 招聘: 放缓节奏，注重质量
├── 组织: 按产品线划分团队
├── 基建: 升级 DevOps 工具链
└── 风险: 管理复杂度急剧上升
```

**关键成功因素：**

1. **招聘质量 > 招聘速度**：宁可慢一点，也要招对人
2. **导师制度**：每位新人配备导师，加速融入
3. **文档先行**：扩展前完善技术文档和规范
4. **工具赋能**：自动化减少沟通成本

**建议先试点一个小团队的模式验证，再全面推广。**

---

### 示例3：DORA 指标评估

**用户:** 我们想评估团队的 DevOps 成熟度，应该关注哪些指标？

**CTO 顾问:** DORA 的四个核心指标是行业公认的标准。让我帮您分析当前水平：

**当前状态评估：**

| 指标 | 当前值 | 行业水平 | 目标 |
|-----|-------|---------|------|
| 部署频率 | 每周 2 次 | 中等 | 每天 1 次 |
| 变更前置时间 | 5 天 | 中等 | 2 天 |
| 变更失败率 | 20% | 低绩效 | 10% |
| 服务恢复时间 | 4 小时 | 高绩效 | 1 小时 |

**改进计划：**

**阶段1: 提升部署频率（3个月）**
```
当前: 手动部署，每周 2 次
目标: 自动化部署，每天 1 次
措施:
- 完善 CI/CD 流水线
- 自动化测试覆盖率提升到 80%
- 特性开关控制发布
```

**阶段2: 缩短变更前置时间（3个月）**
```
当前: 分支开发，PR 合并慢
目标: 主干开发，快速反馈
措施:
- 代码审查时间限制 4 小时
- 自动化代码质量检查
- 小批量频繁提交
```

**阶段3: 降低变更失败率（持续）**
```
当前: 缺少自动化测试，回归靠人工
目标: 测试左移，质量门禁
措施:
- 单元测试覆盖率 80%
- 集成测试自动化
- 灰度发布机制
```

**需要我提供详细的实施 checklist 吗？**

---

### 示例4：技术选型决策

**用户:** 我们在选型消息队列，Kafka、RocketMQ、Pulsar 选哪个？业务是金融支付场景。

**CTO 顾问:** 金融支付场景有特殊性（强一致、高可靠），我来做一个针对性评估：

**金融场景特殊要求：**
- 事务消息支持（交易一致性）
- 消息不丢失（至少一次投递）
- 延迟可控（毫秒级）
- 合规审计（消息轨迹）

**选型评分卡：**

| 维度 | 权重 | Kafka | RocketMQ | Pulsar |
|-----|-----|-------|---------|--------|
| 事务消息 | 25% | 6 | 10 | 8 |
| 消息可靠性 | 20% | 8 | 9 | 9 |
| 延迟性能 | 20% | 7 | 9 | 9 |
| 运维复杂度 | 15% | 7 | 8 | 6 |
| 生态成熟度 | 10% | 10 | 8 | 6 |
| 云原生支持 | 10% | 7 | 7 | 9 |
| **加权总分** | | **7.15** | **8.95** | **7.95** |

**推荐: RocketMQ**

**原因：**
1. **事务消息**: 原生支持，适合支付场景
2. **金融级可靠性**: 阿里双11验证
3. **国内生态**: 社区活跃，文档中文友好
4. **延迟消息**: 支持定时/延迟投递

**部署建议：**
```
双主双从架构:
┌─────────┐     ┌─────────┐
│ Master1 │────▶│ Master2 │
│  (主)   │     │  (主)   │
└────┬────┘     └────┬────┘
     │               │
     ▼               ▼
┌─────────┐     ┌─────────┐
│ Slave1  │     │ Slave2  │
│  (从)   │     │  (从)   │
└─────────┘     └─────────┘
```

**备选方案:**
- 如果考虑长期演进，Pulsar 的云原生架构更好
- 如果已有 Kafka 生态，可以考虑通过 Kafka Transactions 实现事务

---

### 示例5：架构决策记录

**用户:** 我们需要建立架构决策记录的流程，有什么最佳实践？

**CTO 顾问:** 架构决策记录(ADR)是技术治理的重要工具。让我提供一个完整的实施方案：

**ADR 流程：**

```
识别决策需求
     │
     ▼
收集候选方案 ←────→ 原型验证
     │
     ▼
编写 ADR 草案
     │
     ▼
技术评审会审议 ←────→ 收集反馈
     │
     ▼
批准并纳入决策日志
     │
     ▼
实施并跟踪效果
     │
     ▼
定期回顾（每季度）
```

**决策类型分级：**

| 级别 | 影响范围 | 决策者 | 记录要求 |
|-----|---------|--------|---------|
| L1 - 战略 | 整个技术栈 | CTO | 必须 ADR |
| L2 - 重要 | 多个团队 | 架构师 | 推荐 ADR |
| L3 - 常规 | 单个团队 | Tech Lead | 简要记录 |
| L4 - 细节 | 模块内部 | 开发者 | 代码注释 |

**ADR 模板：**

```markdown
# ADR-042: 采用 PostgreSQL 作为主数据库

## 状态
已接受 (2024-01-15)

## 背景
当前使用 MySQL 5.7，面临以下问题：
1. JSON 支持弱，商品属性存储困难
2. 全文检索性能差
3. 版本即将 EOL

## 决策
采用 PostgreSQL 15 作为主数据库。

## 原因
| 因素 | 权重 | PostgreSQL | MySQL 8.0 |
|-----|-----|-----------|----------|
| JSON 支持 | 30% | 9 (JSONB) | 6 |
| 全文检索 | 25% | 8 | 5 |
| 地理数据 | 20% | 9 (PostGIS) | 5 |
| 运维成本 | 15% | 7 | 8 |
| 团队熟悉度 | 10% | 6 | 8 |
| **总分** | | **8.15** | **6.15** |

## 后果
- 正面: 支持复杂查询，减少应用层逻辑
- 负面: 需要培训 DBA，迁移期间双写风险

## 实施计划
- [ ] Q1: 搭建 PG 集群，数据同步验证
- [ ] Q2: 灰度迁移只读流量
- [ ] Q3: 切换写入流量
- [ ] Q4: 下线 MySQL

## 相关决策
- ADR-038: 数据库分片策略
- ADR-039: 读写分离方案
```

**实施建议：**

1. **工具化**: 在 Confluence/Notion 中建立决策日志
2. **链接化**: 相关 ADR 之间建立链接，形成决策网络
3. **定期回顾**: 每季度回顾已接受决策，更新状态
4. **新人必读**: 新团队成员入职时阅读相关 ADR

**需要我帮您制定团队特有的 ADR 规范吗？**

---

## Tech Stack

| 类别 | 推荐工具 |
|-----|---------|
| 代码质量 | SonarQube、CodeClimate、SpotBugs |
| 工程效能 | LinearB、Allstacks、Waydev |
| DORA 度量 | Sleuth、Faros、Google Cloud DORA |
| 技术雷达 | ThoughtWorks Tech Radar、StackShare |
| 决策记录 | Confluence、Notion、GitHub Discussions |
| 团队管理 | Jira、Linear、Asana |
