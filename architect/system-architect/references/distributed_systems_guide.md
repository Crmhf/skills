# 分布式系统设计指南

分布式系统设计的核心原则与实践指南。

---

## 核心理论

### CAP 定理

在分布式系统中，最多只能同时满足以下两项:

| 特性 | 说明 | 取舍建议 |
|-----|------|---------|
| C (Consistency) | 一致性，所有节点数据一致 | 金融交易优先 |
| A (Availability) | 可用性，每个请求都有响应 | 互联网应用优先 |
| P (Partition Tolerance) | 分区容错性，网络分区时仍能运行 | 必须满足 |

**典型选择:**
- CP系统: ZooKeeper、etcd、Consul
- AP系统: Cassandra、Couchbase、Eureka

### BASE 理论

- **B**asically **A**vailable: 基本可用
- **S**oft state: 软状态，允许中间状态
- **E**ventually consistent: 最终一致性

---

## 一致性模型

### 强一致性

```
写入成功 → 立即可见
```

**实现方式:**
- 同步复制
- 分布式锁
- Paxos/Raft 共识算法

### 最终一致性

```
写入成功 → 短暂不一致 → 最终一致
```

**实现方式:**
- 异步复制
- 消息队列
- 冲突解决策略(Last-Write-Wins/向量时钟)

---

## 分布式事务方案

### 2PC (两阶段提交)

```
协调者                    参与者
  |  1. Prepare请求       |
  | --------------------> |  执行本地事务，锁定资源
  | <-------------------- |  返回Yes/No
  |  2. Commit/Rollback   |
  | --------------------> |  提交或回滚
```

**缺点:** 同步阻塞、单点故障

### TCC (Try-Confirm-Cancel)

```
Try阶段: 预留资源
Confirm阶段: 确认执行
Cancel阶段: 取消释放

示例(扣减库存):
Try: 预扣库存(冻结)
Confirm: 确认扣减(解冻并扣除)
Cancel: 释放冻结库存
```

### 本地消息表

```
1. 业务操作 + 插入消息记录 (本地事务)
2. 定时扫描消息表，发送到MQ
3. 消费者处理，成功后删除消息
4. 失败重试，超过阈值告警
```

---

## 分布式共识算法

### Raft

**角色:**
- Leader: 处理所有客户端请求
- Follower: 被动接收日志复制
- Candidate: 选举期间的角色

**关键机制:**
- 心跳机制维持领导地位
- 日志复制保证一致性
- 安全性保证(任期、提交规则)

### Paxos

**阶段:**
1. Prepare: 提议者获取承诺
2. Accept: 接受者接受提议
3. Learn: 学习者获知结果

---

## 负载均衡算法

| 算法 | 说明 | 适用场景 |
|-----|------|---------|
| 轮询(Round Robin) | 依次分配 | 性能相近的服务 |
| 加权轮询 | 按权重分配 | 性能差异大的服务 |
| 最少连接 | 选择当前连接数最少的 | 长连接场景 |
| IP哈希 | 根据IP计算哈希 | 需要会话保持 |
| 一致性哈希 | 带虚拟节点的哈希 | 缓存分片 |

---

## 分布式 ID 生成

### Snowflake 算法

```
64位ID结构:
| 1位符号 | 41位时间戳 | 10位机器ID | 12位序列号 |
```

**优点:** 趋势递增、高性能、无单点

**缺点:** 依赖时钟，时钟回拨会重复

### 号段模式

```
服务 → 从DB获取号段(如1-1000) → 本地分配
服务 → 号段用完 → 获取新号段(1001-2000)
```

---

## 分布式限流

### 令牌桶算法

```
以固定速率向桶中放入令牌
请求消耗令牌，无令牌则拒绝
桶有最大容量，可应对突发流量
```

### 漏桶算法

```
请求进入漏桶，以固定速率流出
桶满则溢出(拒绝)
流量平滑，无法应对突发
```

### 滑动窗口

```
统计最近N秒内的请求数
精确控制，但内存消耗大
```

---

## 分布式缓存

### 缓存更新策略

| 策略 | 说明 | 一致性 | 复杂度 |
|-----|------|-------|-------|
| Cache-Aside | 应用管理缓存 | 中 | 低 |
| Read-Through | 缓存自动加载 | 中 | 中 |
| Write-Through | 写时同步更新 | 高 | 中 |
| Write-Behind | 异步批量写回 | 低 | 高 |

### 缓存穿透/击穿/雪崩

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| 穿透 | 查询不存在的数据 | 布隆过滤器、空值缓存 |
| 击穿 | 热点key过期 | 互斥锁、逻辑过期 |
| 雪崩 | 大量key同时过期 | 随机过期时间、多级缓存 |

---

## 监控与可观测性

### 三大支柱

1. **Metrics (指标)**
   - QPS、RT、错误率
   - 系统资源(CPU/内存/磁盘)
   - 业务指标(订单量、转化率)

2. **Logging (日志)**
   - 结构化日志(JSON)
   - 分布式追踪ID
   - 集中式收集(ELK/Loki)

3. **Tracing (链路追踪)**
   - 请求全链路跟踪
   - 性能瓶颈定位
   - 依赖关系分析

### 健康检查

```
轻量级检查: HTTP 200 OK (存活检查)
深度检查: 数据库连接、依赖服务 (就绪检查)
```
