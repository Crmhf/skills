# 高可用架构模式

构建高可用系统的架构模式与最佳实践。

---

## 可用性等级

| 等级 | 可用性 | 年停机时间 | 适用场景 |
|-----|-------|-----------|---------|
| 2个9 | 99% | 3.65天 | 内部工具 |
| 3个9 | 99.9% | 8.76小时 | 普通业务 |
| 4个9 | 99.99% | 52.6分钟 | 核心业务 |
| 5个9 | 99.999% | 5.26分钟 | 金融/电信 |

---

## 冗余模式

### 主备复制 (Active-Standby)

```
主节点(Active) → 同步复制 → 备节点(Standby)
   ↓                              ↓
处理读写                        只读/待命
   ↓                              ↓
故障时切换 ←─────────────────────┘
```

**切换方式:**
- 人工切换: 确认后手动切换
- 自动切换: 健康检查失败自动切换

### 双主复制 (Active-Active)

```
主节点A ←────同步复制────→ 主节点B
   ↓                         ↓
处理写请求A                 处理写请求B
(如: 用户按ID分片)
```

**要求:** 数据分片，避免写冲突

### 多活架构 (Multi-Active)

```
      全局流量调度(GSLB)
              ↓
    ┌─────────┼─────────┐
    ↓         ↓         ↓
  机房A      机房B      机房C
   ↓↓        ↓↓        ↓↓
  本地DB     本地DB     本地DB
   ↑↑        ↑↑        ↑↑
  └──────────┴──────────┘
       数据同步层
```

---

## 故障转移机制

### 自动故障检测

**健康检查类型:**
```
心跳检测: 每5秒ping，连续3次失败判定故障
业务探测: 模拟真实请求验证服务
资源监控: CPU/内存/磁盘超过阈值告警
```

### 故障转移流程

```
1. 故障检测 (检测时间: 5-15秒)
        ↓
2. 故障确认 (防止误判，多次确认)
        ↓
3. 流量切换 (DNS切换/配置中心更新)
        ↓
4. 服务恢复 (自动重启/扩容)
        ↓
5. 故障恢复后处理 (数据一致性检查)
```

---

## 降级策略

### 功能降级

```
正常模式: 全部功能可用
        ↓
告警触发
        ↓
降级模式:
  - 关闭非核心功能(推荐、统计)
  - 简化页面(静态化)
  - 只读模式(暂停写操作)
        ↓
故障恢复 → 逐步恢复功能
```

### 数据降级

| 降级级别 | 策略 | 用户体验 |
|---------|------|---------|
| L1 | 返回缓存数据 | 可能不是最新 |
| L2 | 返回默认值 | 功能可用 |
| L3 | 返回错误提示 | 功能不可用 |

---

## 限流与熔断

### 限流层级

```
边缘层: CDN/DNS限流 (防止恶意攻击)
    ↓
网关层: API网关限流 (按API/用户限流)
    ↓
服务层: 应用限流 (按服务实例限流)
    ↓
数据库层: 连接池限流 (保护DB)
```

### 熔断器状态机

```
                    成功
        ┌─────────────────────────┐
        ↓                         │
   ┌─────────┐   失败阈值    ┌─────────┐
   │  CLOSED │ ────────────→ │  OPEN   │
   │ (正常)  │               │ (熔断)  │
   └─────────┘ ←──────────── └─────────┘
        ↑        超时时间        │
        │                        │
        └────────────────────────┘
                    半开探测
```

---

## 容灾架构

### 同城容灾

```
同城双中心 (距离 < 50km)
├── RPO: 0 (同步复制)
├── RTO: 分钟级
└── 网络延迟: < 2ms
```

### 异地容灾

```
异地双中心 (距离 > 200km)
├── RPO: 秒级~分钟级 (异步复制)
├── RTO: 小时级
└── 网络延迟: 10-50ms
```

### 两地三中心

```
        生产中心(同城双活)
        ├── 中心A(主)
        └── 中心B(热备)
              ↓ 异步复制
        异地灾备中心(冷备)
```

---

## 数据库高可用

### MySQL 高可用方案

| 方案 | 架构 | 自动切换 | 适用场景 |
|-----|------|---------|---------|
| 主从复制 | 一主多从 | 需配合VIP | 读多写少 |
| MHA | Manager监控 | 支持 | 中小规模 |
| MGR | 组复制 | 支持 | 强一致性需求 |
| ProxySQL | 代理层 | 支持 | 大规模集群 |

### 分库分表高可用

```
数据分片:
  用户ID % 16 → 分片0-15
      ↓
  每个分片: 一主两从
      ↓
  主库故障 → 从库提升为主
```

---

## 缓存高可用

### Redis 高可用

**哨兵模式 (Sentinel):**
```
Sentinel集群监控主从节点
主节点故障 → 自动切换从节点为主
客户端通过Sentinel获取主节点地址
```

**集群模式 (Cluster):**
```
数据分片存储(16384个slot)
每个分片一主多从
自动故障转移和槽位迁移
```

---

## 监控告警

### 黄金指标

```
流量: QPS、并发数
延迟: 平均RT、P99延迟
错误: 错误率、异常类型
饱和度: CPU、内存、连接数使用率
```

### 告警分级

| 级别 | 响应时间 | 通知方式 | 示例 |
|-----|---------|---------|------|
| P0 | 5分钟内 | 电话+短信 | 核心服务不可用 |
| P1 | 15分钟内 | 短信+IM | 错误率超过阈值 |
| P2 | 1小时内 | IM | 资源使用率告警 |
| P3 | 工作日 | 邮件 | 统计类告警 |

---

## 混沌工程

### 故障注入类型

```
基础设施层: 杀死实例、断开网络、占满CPU
应用层: 延迟响应、返回错误、抛出异常
数据层: 数据库慢查询、主从延迟
依赖层: 第三方服务超时、返回错误
```

### 实验原则

1. **最小化爆炸半径** - 从测试环境开始
2. **可观测** - 完善的监控和告警
3. **可回滚** - 快速恢复机制
4. **自动化** - 自动化故障注入和恢复
